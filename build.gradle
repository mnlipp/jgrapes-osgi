/*
 * Master Gradle build script
 *
 * Depends on bndPlugin property set by settings.gradle.
 * and bnd_* values from gradle.properties.
 */

import aQute.bnd.build.Workspace
import aQute.bnd.osgi.Constants

/* Add bnd gradle plugin as a script dependency */
buildscript {
    repositories {
        jcenter()
        mavenCentral()
		maven { url "https://oss.sonatype.org/content/repositories/snapshots/" }
        maven { url 'https://jitpack.io' }
    }
    dependencies {
        classpath bndPlugin
    }
}

plugins {
	id "maven-publish"
	id "signing"
	id "org.jdrupes.mdoclet" version "1.0.3"
}

/* Initialize the bnd workspace */
Workspace.setDriver(Constants.BNDDRIVER_GRADLE)
Workspace.addGestalt(Constants.GESTALT_BATCH, null)

ext {
	bndWorkspace = new Workspace(rootDir, bnd_cnf).setOffline(gradle.startParameter.offline)
	cnf = rootProject.project(bnd_cnf)

	isTravisBuild = System.getenv().get("TRAVIS") == 'true'
}

allprojects {
    repositories {
        jcenter()
        mavenCentral()
		maven { url "https://oss.sonatype.org/content/repositories/snapshots/" }
        maven { url 'https://jitpack.io' }
    }
	
	// Makes Eclipse-groovy handle *.gradle file properly
	apply plugin:'groovy'
}

/* Configure the subprojects */
subprojects {
	dependencies {
		compile localGroovy()
	}

	def bndProject = bndWorkspace.getProject(name)
	if (bndProject != null) {
		plugins.apply 'biz.aQute.bnd'
		
		// artifact_version is defined in cnf/bnd.bnd
		if (bnd.artifact_version) {
			project.version = bnd.artifact_version
		}
	}
	
	if (bndProject != null && project.name != "cnf") {
		apply plugin: 'signing'
		apply plugin: 'maven'
		apply plugin: 'maven-publish'

		group = "org.jgrapes"
		
		task sourcesJar(type: Jar) {
			from sourceSets.main.allJava
			classifier "sources"
		}

		task javadocJar(type: Jar) {
			from (project.rootDir) { include 'README.md' }
			classifier "javadoc"
		}

		// MavenPublishing (new)

		publishing {

			repositories {
				maven {
					name "snapshot"
					url "https://oss.sonatype.org/content/repositories/snapshots/"
					credentials {
						username project.properties['sonatypeUsername'] ?: "nouser"
						password project.properties['sonatypePassword'] ?: "nopass"
					}
				}
				maven {
					name "release"
					url "https://oss.sonatype.org/service/local/staging/deploy/maven2/"
					credentials {
						username project.properties['sonatypeUsername'] ?: "nouser"
						password project.properties['sonatypePassword'] ?: "nopass"
					}
				}
			}
		}

		// Additional configuration of publishing
		apply plugin: ConfigurePublishing

		configurePublishing {
			withPomXml {
				asNode().with {
					appendNode('url', 'http://mnlipp.github.io/jgrapes/')
					appendNode('scm').with {
						appendNode('url', 'scm:git@github.com:mnlipp/jgrapes-osgi.git')
						appendNode('connection', 'scm:git@github.com:mnlipp/jgrapes-osgi.git')
						appendNode('developerConnection', 'git@github.com:mnlipp/jgrapes-osgi.git')
					}
					appendNode('licenses').with {
						appendNode('license').with {
							appendNode('name', 'GPL 3.0')
							appendNode('url', 'https://www.gnu.org/licenses/gpl-3.0.en.html')
							appendNode('distribution', 'repo')
						}
					}
					appendNode('developers').with {
						appendNode('developer').with {
							appendNode('id', 'mnlipp')
							appendNode('name', 'Michael N. Lipp')
						}
					}
				}
			}
		}
	}

	tasks.withType(Javadoc).all { enabled = false }	
	
	afterEvaluate {
		if(project.name == "cnf") {
			tasks.matching { it.group == "upload" ||
				it.group == "publishing" }.all {
				enabled = false
			}
		}
	}
	
}

configurations {
    javadocTaglets
}

dependencies {
    javadocTaglets "org.jdrupes.taglets:plantuml-taglet:1.0.+"
    // javadocTaglets "com.github.mnlipp:jdrupes-taglets:master-SNAPSHOT"
}

javadoc {
	
	options.tagletPath = configurations.javadocTaglets.files as List
	options.taglets = ["org.jdrupes.taglets.plantUml.Taglet"]
	
	classpath = files(subprojects.collect {project ->
		project.sourceSets.main.compileClasspath})
	source subprojects.collect {project -> project.sourceSets.main.allJava }
	options.addStringOption("overview", "overview.md")
	inputs.file "overview.md"
	options.addBooleanOption("use", true)
	options.addBooleanOption("linksource", true)
	options.stylesheetFile(file("stylesheet.css"))
	options.addStringOption("bottom", file("misc/javadoc.bottom.txt").text)
	options.addStringOption("link", "http://docs.oracle.com/javase/8/docs/api/")
	destinationDir = file("../jgrapes.gh-pages/javadoc-osgi")
}
	
task wrapper(type: Wrapper) {
  jarFile = rootProject.file('.gradle-wrapper/gradle-wrapper.jar')
}
